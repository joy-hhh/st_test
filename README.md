# ConsolLab 연결봇

연결봇 ConsolLab은 

## Development Log

![ConsolLab_logo](./ConsolLab_logo.png)


# Excel file teamplates

## CoA (Chart of Account) : CoA_Level.xlsx

CoA_Level.xlsx 파일에는 재무상태표와 손익계산서의 CoA를 정의하는 "BSPL" 시트와 자본변동표를 위한 "CE"시트, 현금흐름표를 위한 "CF"시트로 구성되어 있습니다.

### BSPL
재무제표 요소("FS_Element" - 자산(A), 부채(L), 자본(E), 수익(R), 비용(X), 비지배지분(CE), 비지배지분순이익(CR))와 "계정코드", "계정명"을 기본으로 포함합니다.  
여기에 계정과목 상위 카테고리의 부분합을 계산하기 위한 Level 설정(L1, L2, L3, L4, L5)을 정의합니다.   
  
### CE
첫번째 행은 사람이 보기 위한 계정명 정보를 위치하게 합니다.
두번째 행은 지분율정보와 조정코드(비지배지분 배부를 위한 코드)를 위치하게 합니다.
세번째 행은 자본 L3_code 를 위치하게 합니다.

### CF
재무제표 요소("FS_Element" 1과 -1로 부호 지정)와 "계정코드",	"계정명",	"CF_code", "현금흐름표" 를 기본으로 합니다.    
계정코드와 계정명에는 BSPL의 계정코드 및 계정명을 배치하여 연결조정분개의 해당 항목이 현금흐름표 조정에 반영될 수 있도록 합니다.    
현금흐름표 계정과목 열이름은 "현금흐름표"로 기재합니다.
여기에 현금흐름표 계정 상위 카테고리의 부분합을 계산하기 위한 Level 설정(L1, L2, L3, L4, L5)을 정의합니다.


## FS (재무제표) : 회사명_FS.xlsx

재무제표 파일에는 회사명을 앞에 쓰고 _ 뒤에 재무제표를 알아볼 수 있는 보조정보를 파일명이 되도록 합니다. ConsolLab은 _ 앞의 회사명을 읽어서 회사명을 식별할 수 있도록 합니다.  

### BSPL
"계정코드", "계정명", "금액" 열로 구성합니다.   
계정코드에는 CoA에서 정의한 계정코드와 일치하는 코드가 있어야 합니다.  
금액열은 수치형으로 입력되어야 합니다.

### CE
CoA_Level.xlsx 파일 "CE" 시트의 양식을 모회사, 자회사들이 동일하게 적용합니다.

### CF
CoA_Level.xlsx 파일의 "CF" 시트의 "CF_code", "현금흐름표"와 "금액" 열로 구성합니다.





## 조정명세 조정분개 변환 Logic

### Main Concept : 제거 대상을 정의한다. 

회사명에는 자산을 보유하는 회사명과 수익, 비용이 발생한 회사명을 각각 기재한다. 

* CAJE00_투자자본상계 : 제거 대상 투자주식과 자본 계정코드와 금액을 정의한다. 이 때 영업권과 비지배지분은 제거가 아니라 생겨나게 되므로 - 로 표시한다. 
  
* CAJE01_채권채무제거 : 제거 대상 채권과 채무 계정코드와 금액을 정의한다. 
  - 특이사항 : 전기 금액을 넣어서 CF 변동에 반영되도록 한다. BS에서는 당기만 반영되도록 구현. CF에서는 -(당기 - 전기)로 반영되도록 구현. 

* CAJE02_제품미실현이익제거 : 제거 대상 수익, 비용과 재고자산 계정코드와 금액을 정의한다. 
  - 특이사항 : 전기 미실현이익의 실현을 넣는다. 매출원가와 이익잉여금을 양수로 쓰면 매출원가가 제거되어 이익이 되고 이익잉여금이 제거되어 감소하므로 차대변이 생성된다. 전기와 당기 손익효과를 CF 당기순이익과 재고자산 변동 금액에 반영되도록 구현한다. - 자산 보유 회사의 세율 적용(자산 회사명), 손익 발생 회사에 대하여 비지배지분순이익 배부(손익 회사명)
  - 수익비용 상계 제거도 여기에 포함한다.

* CAJE03_상각자산미실현이익제거 : 제거 대상 상각자산과 누적 이익잉여금 효과 및 감가상각누계액을 모두 정의한다. 
  - 특이사항 : 전기, 당기와 무관하게 모든 입력사항을 분개로 반영하도록 구현한다. - 자산 보유 회사의 세율 적용(자산 회사명), 손익 발생 회사에 대하여 비지배지분순이익 배부(손익 회사명)

* CAJE04_배당조정 : 자회사에서 모회사에 지급한 지분율 해당 제거 대상 배당금수익과 해당 금액의 -를 이익잉여금으로 정의한다.



## 연결 이연법인세 회계처리 Logic

조정분개 유형에 따라서 법인세 회계처리 Logic 수립

당기전기 - 당기에 대해서만 회계처리.

* CAJE00_투자자본상계 : N/A
* CAJE01_채권채무제거 : N/A
* CAJE02_제품미실현이익제거 : FS_Element가 A인 항목을 찾아서 해당 조정 시트 회사명에 써 있는 회사에 맞는 세율을 곱한 금액의 - 를 법인세비용과 이연법인세부채 CAJE97_법인세조정에 입력. - FS_Element가 A 항목 해당 회사(재고 보유 회사)의 세율 적용.
* CAJE03_상각자산미실현이익제거 : FS_Element의 R, X 항목(당기손익)을 찾아서 해당 조정 시트 회사명에 써 있는 회사에 맞는 세율을 곱한 금액의 - 를 법인세비용과 이연법인세부채 CAJE97_법인세조정에 입력.
* CAJE04_배당조정 : N/A
* CAJE05_기타손익조정 : FS_Element의 R, X 항목(당기손익)을 찾아서 해당 조정 시트 회사명에 써 있는 회사에 맞는 세율을 곱한 금액의 - 를 법인세비용과 이연법인세부채 CAJE97_법인세조정에 입력.
* CAJE96_취득일차이조정 : FS_Element의 R, X 항목(당기손익)을 찾아서 해당 조정 시트 회사명에 써 있는 회사에 맞는 세율을 곱한 금액의 - 를 법인세비용과 이연법인세부채 CAJE97_법인세조정에 입력.


## 연결 비지배지분 회계처리 Logic

비지배지분의 구성 요소 : 1. 전기 누적 비지배지분(투자자본상계 포함), 2. 당기 종속회사 자본 변동으로 인한 비지배지분 변동, 3. 미실현이익 비지배지분

당기전기 - 당기에 대해서만 회계처리.

### 1. 전기 누적 비지배지분(투자자본상계 포함)
* 전기 누적 비지배지분(투자자본상계 포함) : 조정분개_입력템플릿 명세에 입력.

### 2. 당기 종속회사 자본 변동으로 인한 비지배지분 변동
* 당기 종속회사 자본 변동으로 인한 비지배지분 변동 : 사이드바에 업로드 된 종속회사들의 "CE" 시트의 자본변동(CE 계정코드 Beginning~Ending 사이)에 비지배지분율을 곱하여 조정분개 생성(조정코드/비지배지분코드, CE 계정코드에 _NI가 있는 항목의 경우 비지배지분순이익코드). -> CAJE98_비지배지분조정에 입력. 
* 기타포괄손익누계액의 이익잉여금 대체 등 자본변동표에 금액이 있으나 합계가 0인 경우에는 비지배지분 배부가 일어나지 않도록 구현.

### 3. 미실현이익 비지배지분
* CAJE02_제품미실현이익제거 : FS_Element의 A 항목 해당 회사(재고 보유 회사)의 세율을 적용하여 세효과 반영. 당기 손익항목에 해당하는 행의 회사명 지분율을 Info에서 찾아서 비지배지분율이 있는 경우(100% 이하인 경우) 비지배지분율을 곱하여 이익잉여금(CoA "AJE"시트에 입력되어 있는)/비지배지분순이익 으로 -> CAJE98_비지배지분조정에 입력.
* CAJE03_상각자산미실현이익제거 : 당기 손익항목에 해당하는 행의 회사명 세율을 적용하여 세효과 반영. FS_Element의 A 항목 해당하는 행의 회사명 지분율을 Info에서 찾아서 비지배지분율이 있는 경우(100% 이하인 경우) 비지배지분율을 곱하여 이익잉여금(CoA "AJE"시트에 입력되어 있는)/비지배지분순이익 으로 -> CAJE98_비지배지분조정에 입력.
* CAJE96_취득일차이조정 : 당기 손익항목에 해당하는 행의 회사명 세율 및 지분율을 Info에서 찾아서 세효과 반영 후 비지배지분율이 있는 경우(100% 이하인 경우) 비지배지분율을 곱하여 이익잉여금(CoA "AJE"시트에 입력되어 있는)/비지배지분순이익 으로 -> CAJE98_비지배지분조정에 입력.



## 조정명세 차기 이월(carry over) Logic
1. CAJE00_투자자본상계 : 그대로 유지한다.
2. CAJE01_채권채무제거 : 전기 행을 삭제하고 당기전기에 당기를 전기로 바꾼다. 
3. CAJE02_제품미실현이익제거 : FS_Element A항목 금액 합계를 이 시트에 들어 있는 FS_Element X 해당 항목 계정을 찾아 그 계정으로 쓰고 이익잉여금(CoA "AJE"시트에 입력되어 있는)으로 쓴다. 부호는 유지한다. (기존 데이터는 삭제하고 이것으로 대체) 당기전기에 당기를 전기로 쓴다. 
4. CAJE03_상각자산미실현이익제거 : 모든 행 데이터가 유지되어야 한다. FS_Element X 해당 항목(감가상각비)의 - 를 이익잉여금(CoA "AJE"시트에 입력되어 있는)으로 변경한다. 당기전기에 당기를 전기로 바꾼다. 
5. CAJE04_배당조정 : 기존 데이터를 삭제한다.
6. CAJE96_취득일차이조정 : FS_Element X 해당 항목 행의 - 를 이익잉여금(CoA "AJE"시트에 입력되어 있는)으로 변경한다. 당기전기에 당기를 전기로 바꾼다.
7. CAJE97_법인세조정 : 전기와 당기 행을 모두 제거한다. 전기 당기가 아닌 것(취득일)은 유지한다. 업로드 된 파일 내용의 다른 조정에서 각 항목에 맞게 새로 이월조정을 생성한다. CAJE02_제품미실현이익제거 에서는 FS_Element A 해당 항목의 금액에 FS_Element A 해당 세율을 반영하여 - 를 각각 법인세비용과 이익잉여금으로 기재한다.(부호 같게)  CAJE03_상각자산미실현이익제거 에서는 누적되어 있는 모든 항목을 반영하여야 한다. FS_Element의 R, X 항목(당기손익)을 찾아서 X인 경우 FS_Element A 해당 세율을 반영하여 - 를 이익잉여금(CoA "AJE"시트에 입력되어 있는)으로 +를 이연법인세부채 CAJE97_법인세조정에 입력. (부호 다르게) CAJE96_취득일차이조정에서는 누적되어 있는 모든 항목을 반영하여야 한다. FS_Element의 R, X 항목(당기손익)을 찾아서 X인 경우 FS_Element R, X 항목 해당 세율을 반영하여 - 를 이익잉여금(CoA "AJE"시트에 입력되어 있는)으로 +를 이연법인세부채 CAJE97_법인세조정에 입력. (부호 다르게)
8. CAJE98_비지배지분조정 : 당기를 전기로 바꾸고 비지배지분순이익을 비지배지분(CE)의 계정코드와 계정명으로 변경한다. 


## 자본변동표 작성 Logic
1. 조정분개 파일의 당기전기 열에 당기가 아닌 것들은 기초 조정으로 반영한다. 
2. 당기 이외 조정분개의 자본항목(FS_Element E)에 대하여 L3_code로 맵핑한다.
3. 자본변동표 2번째 행(계정코드)와 CoA L3_code 가 일치하도록 설계되어 있도록 엑셀 구현.
4. 자본변동표 2번째 행(계정코드)와 비지배지분(FS_Element CE)에 따라서 4번째 행 (Beginning)에 조정분개가 반영되도록 한다.
5. 모회사 및 자회사들의 기초 금액을 모두 합산하고 기초 누적 조정분개를 반영되도록 하여 첫번째 줄(4번째 행 -Beginning)에 쓴다.
6. 모회사 및 자회사  Beginning~Ending 사이의 내용을 모두 Concat으로 붙이고 당기연결 조정분개 중에서 손익에 영향을 미치는 항목은 "CE11_NI" 의 CE 계정코드로 이익잉여금 열(가장 오른쪽 직전)에 위치하게 하고 비지배지분순이익은 비지배지분(가장 오른쪽) 열에 위치하도록 한다. 손익에 영향이 없는 자본항목 조정분개는 다음 줄에 "CE12_CAJE"로 나타나게 한다.
7. 모든 열의 행이 비어 있는 경우(0) 행을 제거한다.
8. Ending 행에 각 열의 합게를 계산하여 나타나게 한다.
9. Ending 행 다음 행에 자본 계정코드(2번째 행) 해당 연결정산표 금액이 나타나게 한다.


